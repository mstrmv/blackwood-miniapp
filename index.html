<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BLACKWOOD CORE</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --gold1:#caa35c;
      --gold2:#8c6a32;
      --stroke: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --radius:20px;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --shadowGold: 0 0 28px rgba(202,163,92,.22);
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color: var(--text);
      background:#000;
      overflow-x:hidden;
    }

    /* ====== –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–´–ô –§–û–ù: –∫–∞—Ä—Ç–∏–Ω–∫–∞ + –ø–µ—Ä–µ–ª–∏–≤ ====== */
    .bg{
      position: fixed;
      inset: 0;
      z-index:-3;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(202,163,92,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(202,163,92,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.92), rgba(15,15,15,.88));
    }
    .bg::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: url("./images/bg_blackwood.jpg");
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      opacity:.30;
      transform: scale(1.05);
    }
    .bg::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(202,163,92,.18),
          rgba(255,255,255,.07),
          rgba(202,163,92,.12),
          rgba(0,0,0,0),
          rgba(202,163,92,.16)
        );
      animation: shimmer 10s linear infinite;
      opacity:.75;
      mix-blend-mode: screen;
      filter: blur(34px);
    }
    @keyframes shimmer{
      0%   { transform: translate(-6%, -4%) rotate(0deg) }
      50%  { transform: translate(6%, 4%) rotate(180deg) }
      100% { transform: translate(-6%, -4%) rotate(360deg) }
    }

    /* ====== –û–ë–Å–†–¢–ö–ê ====== */
    .app{
      min-height: 100dvh;
      padding: calc(12px + var(--safeTop)) 12px calc(98px + var(--safeBottom));
    }

    /* ====== TOP ====== */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand .title{
      font-weight:900;
      letter-spacing:.6px;
      font-size:20px;
      line-height:1.1;
    }
    .brand .title span{
      color: var(--gold1);
      text-shadow: 0 0 18px rgba(202,163,92,.35);
    }
    .brand .subtitle{
      font-size:12px;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.35);
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadowGold);
      user-select:none;
      white-space:nowrap;
    }

    /* ====== TABS ====== */
    .tabs{display:flex; gap:8px; margin:10px 0 14px;}
    .tabbtn{
      flex:1;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      color: var(--muted);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:800;
      letter-spacing:.2px;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }
    .tabbtn.active{
      color:#000;
      border-color: rgba(202,163,92,.55);
      background: linear-gradient(135deg, var(--gold1), var(--gold2));
      box-shadow: 0 0 24px rgba(202,163,92,.28);
    }

    /* ====== PANELS ====== */
    .panel{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.36);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panel-inner{ padding: 14px; }

    /* ====== GRID ====== */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width: 480px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* ====== PRODUCT CARD ====== */
    .product{
      position:relative;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(30,30,30,.55), rgba(0,0,0,.28));
      border-radius: 18px;
      padding:12px;
      overflow:hidden;
    }
    .product::before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(240px 140px at 30% 15%, rgba(202,163,92,.18), transparent 60%);
      pointer-events:none;
    }

    .badge{
      position:absolute;
      top:10px; left:10px;
      font-size:11px;
      font-weight:900;
      letter-spacing:.5px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:6px;
    }
    .badge.hit{ border-color: rgba(202,163,92,.55); box-shadow: 0 0 18px rgba(202,163,92,.22); }
    .badge.best{ border-color: rgba(53,208,127,.55); box-shadow: 0 0 18px rgba(53,208,127,.18); }

    .p-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .icon{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-size:20px;
      box-shadow: var(--shadowGold);
      flex:0 0 auto;
    }
    .p-img{
      width:100%;
      height:108px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:grid; place-items:center;
      overflow:hidden;
      margin-bottom:10px;
    }
    .p-img img{ width:100%; height:100%; object-fit: contain; }

    .p-name{ font-weight:900; letter-spacing:.5px; margin:0 0 2px; font-size:13px; }
    .p-desc{ margin:0 0 10px; font-size:12px; color: var(--muted); line-height:1.2; min-height: 30px; }
    .p-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .price{ font-weight:900; font-size:13px; color: rgba(255,255,255,.92); }

    .btn{
      border:none; cursor:pointer;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:900;
      background: linear-gradient(135deg, var(--gold1), var(--gold2));
      color:#000;
      box-shadow: 0 0 22px rgba(202,163,92,.25);
      min-width: 92px;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn:active{ transform: translateY(1px); }

    /* ====== FORMS ====== */
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .label{ font-size:12px; color: var(--muted); }
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding:12px;
      outline:none;
      backdrop-filter: blur(10px);
    }
    textarea{ min-height: 84px; resize: vertical; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hint{ font-size:12px; color: var(--muted); line-height:1.35; }

    /* ====== BOTTOM BAR ====== */
    .bottom{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.65), rgba(0,0,0,.92));
      backdrop-filter: blur(14px);
      z-index:50;
    }
    .bottom-inner{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,12,12,.72);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow);
    }
    .cartline{ display:flex; flex-direction:column; gap:2px; }
    .cartline b{ font-size:13px; }
    .cartline span{ font-size:12px; color: var(--muted); }

    /* ====== MODAL ====== */
    .modal{ position: fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:flex-end; z-index:100; }
    .modal.open{ display:flex; }
    .sheet{
      width:100%;
      max-height: 88dvh;
      border-radius: 22px 22px 0 0;
      background: rgba(12,12,12,.92);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      box-shadow: 0 -24px 80px rgba(0,0,0,.65);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheet-head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheet-head b{ font-size:14px; }
    .sheet-body{ padding: 12px 14px; overflow:auto; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .item:last-child{ border-bottom:none; }
    .item-left{ display:flex; gap:10px; align-items:center; min-width: 0; }
    .item-left .mini{
      width:38px; height:38px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .item-left .txt{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .item-left .txt b{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-left .txt span{ font-size:12px; color: var(--muted); }
    .qty{ display:flex; align-items:center; gap:8px; }
    .qty button{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
    }
    .qty i{ font-style: normal; min-width: 22px; text-align:center; font-weight:900; }

    .totalbox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .totalbox b{ font-size:14px; }
    .totalbox span{ color: var(--muted); font-size:12px; }

    .sheet-actions{
      padding: 12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
    }
    .sheet-actions .btn{ flex:1; }

    .toast{
      position: fixed;
      left: 12px; right: 12px;
      top: calc(12px + var(--safeTop));
      z-index: 200;
      display:none;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      font-size:12px;
      color: rgba(255,255,255,.92);
    }
    .toast.show{ display:block; }
    code{ color: rgba(255,255,255,.85); }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="title">BLACKWOOD <span>CORE</span></div>
        <div class="subtitle">Hardwood Charcoal Briquettes</div>
      </div>
      <div class="pill" id="userPill">WB Mini App</div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" data-tab="catalog">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button class="tabbtn" data-tab="nova">–ù–æ–≤–∞ –ü–æ—à—Ç–∞</button>
      <button class="tabbtn" data-tab="cod">–ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂</button>
    </div>

    <div class="panel" id="tab-catalog">
      <div class="panel-inner">
        <div class="grid" id="products"></div>
        <div style="height:10px"></div>
        <div class="hint">
          üí° –ú–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω: –ê–∫—Ü–∏–∏/–ü—Ä–æ–º–æ–∫–æ–¥, –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, FAQ, –ü–æ–¥–¥–µ—Ä–∂–∫–∞, –ü–æ–ª–∏—Ç–∏–∫–∏/–æ—Ñ–µ—Ä—Ç–∞.
        </div>
      </div>
    </div>

    <div class="panel" id="tab-nova" style="display:none">
      <div class="panel-inner">
        <div class="hint" style="margin-bottom:10px">
          –ó–∞–ø–æ–ª–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫—É. –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑ —É–π–¥–µ—Ç –±–æ—Ç—É —á–µ—Ä–µ–∑ <code>sendData()</code>.
        </div>

        <div class="row2">
          <div class="field">
            <div class="label">–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</div>
            <input id="npName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" autocomplete="name" />
          </div>
          <div class="field">
            <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
            <input id="npPhone" placeholder="+380..." inputmode="tel" autocomplete="tel" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <div class="label">–ì–æ—Ä–æ–¥</div>
            <input id="npCity" placeholder="–ö–∏–µ–≤ / –õ—å–≤–æ–≤..." />
          </div>
          <div class="field">
            <div class="label">–û—Ç–¥–µ–ª–µ–Ω–∏–µ / –ü–æ—á—Ç–æ–º–∞—Ç</div>
            <input id="npBranch" placeholder="‚Ññ12 / –ü–æ—á—Ç–æ–º–∞—Ç 3456" />
          </div>
        </div>

        <div class="field">
          <div class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
          <textarea id="npComment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π"></textarea>
        </div>
      </div>
    </div>

    <div class="panel" id="tab-cod" style="display:none">
      <div class="panel-inner">
        <div class="field">
          <div class="label">–û–ø–ª–∞—Ç–∞</div>
          <select id="payType">
            <option value="cod">–ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (–ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏)</option>
            <option value="prepay">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∞/–ø–µ—Ä–µ–≤–æ–¥)</option>
          </select>
        </div>

        <div class="field">
          <div class="label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –æ–ø–ª–∞—Ç–µ</div>
          <textarea id="payNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 100 –≥—Ä–Ω –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"></textarea>
        </div>

        <div class="hint">üí° –õ—É—á—à–µ: –¥–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏—è/–∫–æ–º–∏—Å—Å–∏–∏ –∏ ‚Äú—á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ –∑–∞–±—Ä–∞–ª–∏ –ø–æ—Å—ã–ª–∫—É‚Äù.</div>
      </div>
    </div>
  </div>

  <!-- bottom cart -->
  <div class="bottom">
    <div class="bottom-inner">
      <div class="cartline">
        <b id="cartCount">–ö–æ—à–∏–∫: 0 —à—Ç</b>
        <span id="cartSum">–°—É–º–∞: 0 ‚Ç¥</span>
      </div>
      <button class="btn" id="openCartBtn">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </div>

  <!-- modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-head">
        <b>–ö–æ—Ä–∑–∏–Ω–∞</b>
        <button class="btn secondary" id="closeModalBtn" style="min-width:auto">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="sheet-body">
        <div id="cartItems"></div>

        <div class="totalbox">
          <div>
            <b id="totalText">–ò—Ç–æ–≥–æ: 0 ‚Ç¥</b><br>
            <span>–î–æ—Å—Ç–∞–≤–∫—É –∑–∞–ø–æ–ª–Ω–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚Äú–ù–æ–≤–∞ –ü–æ—à—Ç–∞‚Äù</span>
          </div>
          <button class="btn secondary" id="clearBtn" style="min-width:auto">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn secondary" id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

    const $ = (id)=>document.getElementById(id);

    // –¢–û–í–ê–†–´ (–∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ ./images)
    // –ü–æ—Å—Ç–∞–≤—å —Ü–µ–Ω—ã –≤ price, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
    const PRODUCTS = [
      {
        id: "core-3",
        name: "CORE 3 KG",
        tag: null,
        tagClass: "",
        emoji: "üçî",
        desc: "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ö–∞–∫ –±—É—Ä–≥–µ—Ä ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.",
        price: 0,
        img: "./images/core-3kg.png"
      },
      {
        id: "core-5",
        name: "CORE 5 KG",
        tag: "–•–ò–¢",
        tagClass: "hit",
        emoji: "üçü",
        desc: "–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ö–∞–∫ —Ñ—Ä–∏ ‚Äî –ª—é–±–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç.",
        price: 0,
        img: "./images/core-5kg.png"
      },
      {
        id: "core-8",
        name: "CORE 8 KG",
        tag: "–í–´–ì–û–î–ù–û",
        tagClass: "best",
        emoji: "üß∫",
        desc: "–ú–∞–∫—Å–∏–º—É–º –æ–±—ä—ë–º–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—è. –î–ª—è —Ç–µ—Ö, –∫—Ç–æ –±–µ—Ä—ë—Ç –Ω–∞–¥–æ–ª–≥–æ.",
        price: 0,
        img: "./images/core-8kg.png"
      }
    ];

    // Tabs
    const tabs = document.querySelectorAll(".tabbtn");
    const mapTab = { catalog: $("tab-catalog"), nova: $("tab-nova"), cod: $("tab-cod") };
    tabs.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        tabs.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        Object.entries(mapTab).forEach(([k,el])=> el.style.display = (k===tab) ? "block" : "none");
      });
    });

    // Render products
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function formatPrice(n){
      buildLocaleOnce();
      const v = Number(n || 0);
      return `${v.toLocaleString("uk-UA")} ‚Ç¥`;
    }
    function renderProducts(){
      const wrap = $("products");
      wrap.innerHTML = "";
      for (const p of PRODUCTS){
        const el = document.createElement("div");
        el.className = "product";
        el.innerHTML = `
          ${p.tag ? `<div class="badge ${p.tagClass}">‚≠ê ${p.tag}</div>` : ``}
          <div class="p-top">
            <div class="icon">${p.emoji}</div>
            <div class="price">${formatPrice(p.price)}</div>
          </div>
          <div class="p-img">
            <img src="${p.img}" alt="${escapeHtml(p.name)}"
              onerror="this.style.display='none'; this.parentElement.textContent='–ù–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ø—Ä–æ–≤–µ—Ä—å –∏–º—è —Ñ–∞–π–ª–∞)';" />
          </div>
          <div class="p-name">${escapeHtml(p.name)}</div>
          <div class="p-desc">${escapeHtml(p.desc)}</div>
          <div class="p-row">
            <button class="btn secondary" onclick="addToCart('${p.id}', 1)">+1</button>
            <button class="btn" onclick="addToCart('${p.id}', 1)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        `;
        wrap.appendChild(el);
      }
    }

    // Cart
    const cart = load("cart") || {};
    function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    function load(k){ try{ return JSON.parse(localStorage.getItem(k) || "null"); }catch(e){ return null; } }

    function addToCart(id, qty){
      cart[id] = (cart[id] || 0) + qty;
      if (cart[id] <= 0) delete cart[id];
      save("cart", cart);
      updateCartUI();
      toast("–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ");
    }
    function setQty(id, qty){
      if (qty <= 0) delete cart[id];
      else cart[id] = qty;
      save("cart", cart);
      updateCartUI();
    }
    function cartStats(){
      let count = 0, sum = 0;
      for (const [id,qty] of Object.entries(cart)){
        const p = PRODUCTS.find(x=>x.id===id);
        if (!p) continue;
        count += qty;
        sum += (p.price || 0) * qty;
      }
      return {count, sum};
    }
    function updateCartUI(){
      const {count, sum} = cartStats();
      $("cartCount").textContent = `–ö–æ—à–∏–∫: ${count} —à—Ç`;
      $("cartSum").textContent = `–°—É–º–∞: ${formatPrice(sum)}`;

      const items = $("cartItems");
      items.innerHTML = "";
      const entries = Object.entries(cart);

      if (!entries.length){
        items.innerHTML = `<div class="hint">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è. –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä –≤ ¬´–ö–∞—Ç–∞–ª–æ–≥¬ª.</div>`;
      } else {
        for (const [id,qty] of entries){
          const p = PRODUCTS.find(x=>x.id===id);
          if (!p) continue;
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="item-left">
              <div class="mini">${p.emoji}</div>
              <div class="txt">
                <b>${escapeHtml(p.name)}</b>
                <span>${formatPrice(p.price)} √ó ${qty} = <b>${formatPrice((p.price||0)*qty)}</b></span>
              </div>
            </div>
            <div class="qty">
              <button onclick="setQty('${id}', ${qty-1})">‚àí</button>
              <i>${qty}</i>
              <button onclick="setQty('${id}', ${qty+1})">+</button>
            </div>
          `;
          items.appendChild(row);
        }
      }
      $("totalText").textContent = `–ò—Ç–æ–≥–æ: ${formatPrice(sum)}`;
    }

    // Order payload
    function buildOrder(){
      const items = Object.entries(cart).map(([id,qty])=>{
        const p = PRODUCTS.find(x=>x.id===id);
        return p ? ({ id, name:p.name, qty, price:p.price||0, sum:(p.price||0)*qty }) : null;
      }).filter(Boolean);

      const delivery = {
        name: $("npName").value.trim(),
        phone: $("npPhone").value.trim(),
        city: $("npCity").value.trim(),
        branch: $("npBranch").value.trim(),
        comment: $("npComment").value.trim()
      };

      const payment = {
        type: $("payType").value,
        note: $("payNote").value.trim()
      };

      const totals = cartStats();

      return { brand:"BLACKWOOD CORE", ts:new Date().toISOString(), items, totals, delivery, payment };
    }

    function orderToText(order){
      const lines = [];
      lines.push("BLACKWOOD CORE ‚Äî –ó–ê–ö–ê–ó");
      lines.push("");
      order.items.forEach(it=> lines.push(`‚Ä¢ ${it.name} √ó ${it.qty} = ${formatPrice(it.sum)}`));
      lines.push("");
      lines.push(`–ò–¢–û–ì–û: ${formatPrice(order.totals.sum)} (${order.totals.count} —à—Ç)`);
      lines.push("");
      lines.push("–î–û–°–¢–ê–í–ö–ê (–ù–æ–≤–∞ –ü–æ—à—Ç–∞):");
      lines.push(`–ò–º—è: ${order.delivery.name || "-"}`);
      lines.push(`–¢–µ–ª: ${order.delivery.phone || "-"}`);
      lines.push(`–ì–æ—Ä–æ–¥: ${order.delivery.city || "-"}`);
      lines.push(`–û—Ç–¥–µ–ª–µ–Ω–∏–µ: ${order.delivery.branch || "-"}`);
      lines.push(`–ö–æ–º–º–µ–Ω—Ç: ${order.delivery.comment || "-"}`);
      lines.push("");
      lines.push("–û–ü–õ–ê–¢–ê:");
      lines.push(`–¢–∏–ø: ${order.payment.type === "cod" ? "–ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂" : "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞"}`);
      lines.push(`–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${order.payment.note || "-"}`);
      return lines.join("\n");
    }

    function validateOrder(order){
      if (!order.items.length) return "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è";
      return null;
    }

    // Modal
    const modal = $("modal");
    $("openCartBtn").addEventListener("click", ()=>{ updateCartUI(); modal.classList.add("open"); });
    $("closeModalBtn").addEventListener("click", ()=> modal.classList.remove("open"));
    modal.addEventListener("click", (e)=>{ if (e.target === modal) modal.classList.remove("open"); });

    $("clearBtn").addEventListener("click", ()=>{
      for (const k of Object.keys(cart)) delete cart[k];
      save("cart", cart);
      updateCartUI();
      toast("–û—á–∏—â–µ–Ω–æ üßπ");
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const order = buildOrder();
      const err = validateOrder(order);
      if (err) return toast(err, true);

      const text = orderToText(order);
      try{ await navigator.clipboard.writeText(text); toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ üìã"); }
      catch(e){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", true); }
    });

    $("sendBtn").addEventListener("click", ()=>{
      const order = buildOrder();
      const err = validateOrder(order);
      if (err) return toast(err, true);

      const payload = JSON.stringify(order);
      if (tg && tg.sendData){
        try{ tg.sendData(payload); toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É ‚úÖ"); modal.classList.remove("open"); }
        catch(e){ toast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ WebApp", true); }
      } else {
        toast("WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ—Ç–∫—Ä–æ–π –∫–∞–∫ Mini App)", true);
      }
    });

    // Toast
    function toast(msg, danger=false){
      const el = $("toast");
      el.textContent = msg;
      el.style.borderColor = danger ? "rgba(255,77,77,.35)" : "rgba(255,255,255,.10)";
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    // Locale cache helper
    let __localeBuilt = false;
    function buildLocaleOnce(){ if (__localeBuilt) return; __localeBuilt = true; }

    // Init user pill
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
      const u = tg.initDataUnsafe.user;
      $("userPill").textContent = `@${u.username || "user"} ‚Ä¢ Mini App`;
    } else {
      $("userPill").textContent = "Mini App ‚Ä¢ Web";
    }

    // Init
    renderProducts();
    updateCartUI();
  </script>
</body>
</html>
